<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TravelBird Â· è¯­ä¹‰å¯¼èˆª Â· åœ°å›¾åŸå‹</title>
  <!-- âœ… é«˜å¾·å®‰å…¨å¯†é’¥ï¼ˆè‹¥ä½ çš„Keyè¦æ±‚å®‰å…¨ç ï¼Œå¿…é¡»é…ç½®ï¼‰ã€‚åœ¨ .env é‡Œä¹Ÿè¯·åŒæ­¥é…ç½® -->
  <script>
    window._AMapSecurityConfig = {
      securityJsCode: "SECURITY_JS_CODE_æ›¿æ¢æˆä½ çš„å®‰å…¨å¯†é’¥"
    };
  </script>
  <!-- âœ… é«˜å¾· JSAPI åŠ è½½å™¨ï¼ˆ2.xï¼‰-->
  <script src="https://webapi.amap.com/loader.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --brand: #4f46e5;
      --brand-2: #22d3ee;
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --rounded: 18px;
    }
    * { box-sizing: border-box; }
    html,body { height: 100%; }
    body { margin:0; background: radial-gradient(1200px 600px at 15% -10%, rgba(79,70,229,.25), transparent),
                           radial-gradient(1200px 600px at 85% -10%, rgba(34,211,238,.25), transparent), var(--bg);
           color: var(--text); font: 14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    .app { display: grid; grid-template-columns: 380px 1fr; gap: 16px; height: 100%; padding: 16px; }
    .panel { background: linear-gradient(180deg, rgba(18,26,43,.9), rgba(18,26,43,.8)); border: 1px solid rgba(148,163,184,.15); border-radius: var(--rounded); box-shadow: var(--shadow); display:flex; flex-direction:column; overflow: hidden; }
    .panel-header { padding: 18px 18px 8px; border-bottom: 1px solid rgba(148,163,184,.12); }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px; }
    .brand .dot { width: 10px; height:10px; background: linear-gradient(45deg, var(--brand), var(--brand-2)); border-radius: 50%; box-shadow: 0 0 0 4px rgba(79,70,229,.25); }
    .subtitle { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .panel-body { padding: 16px; overflow: auto; }
    .field { margin-bottom: 12px; }
    .label { display:block; font-size:12px; color: var(--muted); margin-bottom:6px; }
    .input, .select { width:100%; padding:12px 14px; border-radius: 12px; background: #0d1424; border:1px solid rgba(148,163,184,.18); color: var(--text); outline:none; }
    .row { display:flex; gap:10px; }
    .btn { border:0; padding: 12px 14px; border-radius: 12px; font-weight:600; cursor:pointer; transition: .2s transform ease, .2s opacity ease; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(135deg, var(--brand), var(--brand-2)); color:white; }
    .btn-ghost { background: transparent; color: var(--muted); border:1px solid rgba(148,163,184,.2); }
    .chip-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { padding:6px 10px; border-radius: 999px; font-size:12px; background: #0d1424; border:1px solid rgba(148,163,184,.2); color: #cbd5e1; cursor:pointer; }
    .help { font-size: 12px; color: var(--muted); margin-top: 8px; }
    .divider { display:flex; align-items:center; gap:10px; margin: 14px 0; }
    .divider .line { height:1px; background: rgba(148,163,184,.18); flex:1; }
    .divider .text { font-size: 12px; color: var(--muted); }
    .map-wrap { position: relative; border-radius: var(--rounded); overflow: hidden; border: 1px solid rgba(148,163,184,.15); box-shadow: var(--shadow); }
    #map { width:100%; height:100%; min-height: calc(100vh - 32px); }
    .floating { position: absolute; right: 16px; top: 16px; display:flex; flex-direction:column; gap:8px; }
    .fab { padding:10px 12px; border-radius: 12px; border:1px solid rgba(148,163,184,.2); background: rgba(11,18,32,.65); color:#e2e8f0; backdrop-filter: blur(8px); cursor:pointer; }
    .route-panel { margin-top: 10px; background: #0d1424; border:1px solid rgba(148,163,184,.18); border-radius: 12px; max-height: 220px; overflow:auto; padding: 10px; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background: rgba(16,185,129,.15); color:#a7f3d0; font-size: 11px; margin-left: 6px; }
    .legend { display:flex; gap:8px; align-items:center; font-size: 12px; color:#cbd5e1; }
    .dotA,.dotB,.dotC{ width:8px; height:8px; border-radius:50%; }
    .dotA{ background:#34d399; } /* èµ·ç‚¹ */
    .dotB{ background:#60a5fa; } /* é€”å¾„ */
    .dotC{ background:#f43f5e; } /* ç»ˆç‚¹ */
    .footer { padding: 10px 16px; border-top: 1px solid rgba(148,163,184,.12); color: var(--muted); font-size: 12px; }
    .status { margin-left: 6px; }
    @media (max-width: 960px){ .app{ grid-template-columns: 1fr; } #map{ min-height: 60vh; } }
  </style>
</head>
<body>
  <div class="app">
    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <aside class="panel" role="complementary" aria-label="æ§åˆ¶é¢æ¿">
      <div class="panel-header">
        <div class="brand">
          <span class="dot" aria-hidden></span>
          <div>TravelBird Â· åŸå¸‚è¯­ä¹‰å¯¼èˆª <span class="pill">åœ°å›¾APIæ¥å…¥</span></div>
        </div>
        <div class="subtitle">æŒ‰ç…§å¼€é¢˜PPTï¼šå…ˆæ‰“é€šåœ°å›¾å±‚ï¼ˆPOI/åœ°ç†ç¼–ç /é©¾è½¦è·¯å¾„ï¼‰ï¼Œåç»­å†æŒ‚æ¥è¯­ä¹‰ç†è§£ä¸å¤šæ¨¡æ€ã€‚</div>
      </div>
      <div class="panel-body">
        <!-- è¯­ä¹‰æŸ¥è¯¢ï¼ˆå¯é€‰ï¼šå¦‚æœä½ å·²å¯åŠ¨åç«¯ /process_queryï¼‰ -->
        <div class="field">
          <label class="label">è‡ªç„¶è¯­è¨€éœ€æ±‚ï¼ˆå¯é€‰ï¼‰</label>
          <input id="query" class="input" placeholder="ä¾‹å¦‚ï¼šä»äº‘å—å¤§å­¦ä¸œé™†æ ¡åŒºåˆ°ç¿ æ¹–ï¼Œé¡ºè·¯ç»è¿‡é€‚åˆæ‹ç…§çš„å’–å•¡é¦†" />
          <div class="chip-list" id="examples"></div>
          <div class="row" style="margin-top:8px;">
            <button id="btnSemantic" class="btn btn-primary" title="è°ƒç”¨åç«¯è¯­ä¹‰æ¥å£ï¼Œå°†ç»“æœè½åˆ°åœ°å›¾">è¯­ä¹‰è§£æ â†’ åœ°å›¾</button>
            <button id="btnClear" class="btn btn-ghost" title="æ¸…ç©ºåœ°å›¾å…ƒç´ ">æ¸…ç©º</button>
          </div>
          <div class="help">æœªå¯åŠ¨åç«¯æ—¶ï¼Œå¯ç›´æ¥ç”¨ä¸‹é¢çš„â€œæ‰‹åŠ¨è®¾ç½®èµ·ç»ˆç‚¹/é€”å¾„ç‚¹â€ã€‚</div>
        </div>

        <div class="divider"><span class="line"></span><span class="text">æˆ–</span><span class="line"></span></div>

        <!-- æ‰‹åŠ¨åœ°ç†ç¼–ç ä¸è·¯å¾„è§„åˆ’ -->
        <div class="field">
          <label class="label">èµ·ç‚¹</label>
          <input id="start" class="input" placeholder="ä¾‹å¦‚ï¼šäº‘å—å¤§å­¦ä¸œé™†æ ¡åŒºæ­£é—¨" />
        </div>
        <div class="field">
          <label class="label">é€”å¾„ç‚¹ï¼ˆå¯ç•™ç©ºï¼Œå¤šç‚¹ç”¨ä¸­æ–‡é€—å·éš”å¼€ï¼‰</label>
          <input id="via" class="input" placeholder="ä¾‹å¦‚ï¼šç¿ æ¹–å…¬å›­ä¸œé—¨, èƒ¡æ¡ƒé‡Œæ˜†æ˜åº—" />
        </div>
        <div class="field">
          <label class="label">ç»ˆç‚¹</label>
          <input id="end" class="input" placeholder="ä¾‹å¦‚ï¼šè®²æ­¦å ‚æ—§å€" />
        </div>
        <div class="row">
          <button id="btnPlan" class="btn btn-primary">è§„åˆ’è·¯çº¿</button>
          <button id="btnFit" class="btn btn-ghost">è§†é‡é€‚é…</button>
        </div>

        <div class="divider"><span class="line"></span><span class="text">åœ°å›¾çŠ¶æ€</span><span class="line"></span></div>
        <div class="legend">
          <span class="dotA"></span> èµ·ç‚¹
          <span class="dotB"></span> é€”å¾„
          <span class="dotC"></span> ç»ˆç‚¹
        </div>
        <div id="msg" class="help" style="margin-top:6px;">å°±ç»ª âœ…</div>

        <div class="route-panel" id="routePanel" aria-live="polite"></div>
      </div>
      <div class="footer">åŸºäº <strong>TravelBird</strong> ä»“åº“æ¨¡æ¿é‡å†™å‰ç«¯é¡µï¼Œä»…å®ç°åœ°å›¾ API æ¥å…¥ä¸åŸºç¡€æ¼”ç¤ºã€‚</div>
    </aside>

    <!-- å³ä¾§åœ°å›¾ -->
    <main class="map-wrap" role="main" aria-label="åœ°å›¾">
      <div id="map"></div>
      <div class="floating">
        <button id="btnStyle" class="fab" title="åˆ‡æ¢åº•å›¾æ ·å¼">åˆ‡æ¢æ ·å¼</button>
        <button id="btnLocate" class="fab" title="å®šä½åˆ°æ˜†æ˜">å®šä½æ˜†æ˜</button>
      </div>
    </main>
  </div>

  <script>
    // ----------- é…ç½®åŒºï¼ˆä¸ä½ çš„ .env / README å¯¹åº”ï¼‰-----------
    const AMAP_KEY = "AMAP_MAPS_API_KEY_æ›¿æ¢æˆä½ çš„Key"; // ğŸ“Œ å°†è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„ Keyï¼ˆä¸ README ä¸€è‡´ï¼‰

    // ----------- çŠ¶æ€ä¸é€šç”¨å·¥å…· -----------
    const $ = (sel) => document.querySelector(sel);
    const msg = (text, level = "info") => {
      const el = $("#msg");
      const icon = level === 'error' ? 'âŒ' : level === 'warn' ? 'âš ï¸' : 'âœ…';
      el.textContent = `${text} ${icon}`;
    };

    const examples = [
      "ä»åŒ—äº¬å¤§å­¦åˆ°æ•…å®«ï¼Œæƒ³è·¯ä¸Šç»è¿‡å¥½æ‹ç…§çš„å’–å•¡é¦†",
      "ä»ä¸Šæµ·å¤–æ»©åˆ°è¿ªå£«å°¼ï¼Œå°½é‡ä¸èµ°é«˜æ¶",
      "æ˜†æ˜ä¸œé™†æ ¡åŒºå‘¨è¾¹ 3 ä¸ªå®‰é™è‡ªä¹ å’–å•¡é¦†ï¼Œå¹¶ä¸²æˆæ­¥è¡Œè·¯çº¿",
      "ä»æˆéƒ½äººæ°‘å…¬å›­éª‘è¡Œåˆ°å¤ªå¤é‡Œï¼Œé¿å¼€æ‹¥å µ"
    ];

    // ----------- åœ°å›¾åˆå§‹åŒ– -----------
    let AMapJS = null, map = null, geocoder = null, driving = null;
    let markers = [], styleIdx = 0;

    function addMarker(lnglat, type, title) {
      const color = type === 'start' ? '#34d399' : type === 'end' ? '#f43f5e' : '#60a5fa';
      const marker = new AMapJS.Marker({
        position: lnglat,
        title,
        offset: new AMapJS.Pixel(-10, -10),
        content: `<div style="width:18px;height:18px;border-radius:50%;background:${color};box-shadow:0 0 0 3px rgba(255,255,255,.4);"></div>`
      });
      marker.setMap(map);
      markers.push(marker);
      return marker;
    }

    function clearMap() {
      markers.forEach(m => m.setMap(null));
      markers = [];
      if (driving) driving.clear();
      $("#routePanel").innerHTML = "";
    }

    async function loadAMap() {
      msg("æ­£åœ¨åŠ è½½åœ°å›¾â€¦");
      return new Promise((resolve, reject) => {
        AMapLoader.load({ key: AMAP_KEY, version: "2.0", plugins: ["AMap.Geocoder","AMap.Driving","AMap.AutoComplete","AMap.PlaceSearch"] })
          .then((AMap) => {
            AMapJS = AMap;
            map = new AMap.Map("map", { zoom: 12, center: [102.707, 25.044], mapStyle: "amap://styles/darkblue", viewMode: "3D", resizeEnable: true });
            geocoder = new AMap.Geocoder();
            driving = new AMap.Driving({ map, policy: AMap.DrivingPolicy.LEAST_TIME, ferry: 0, province: "äº‘å—" });
            msg("åœ°å›¾åŠ è½½å®Œæˆ");
            resolve();
          })
          .catch((e) => { msg("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key / å®‰å…¨ç ", 'error'); reject(e); });
      });
    }

    // ----------- è¯­ä¹‰åˆ°åœ°å›¾ï¼ˆå¯é€‰åç«¯ï¼‰ -----------
    async function semanticToMap() {
      const q = $("#query").value.trim();
      if (!q) { msg("è¯·è¾“å…¥è‡ªç„¶è¯­è¨€éœ€æ±‚ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹æ‰‹åŠ¨æ–¹å¼", 'warn'); return; }
      msg("è°ƒç”¨åç«¯è¿›è¡Œè¯­ä¹‰è§£æä¸­â€¦");
      try {
        const resp = await fetch('/process_query', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `query=${encodeURIComponent(q)}` });
        if (!resp.ok) throw new Error("åç«¯æœªå¯åŠ¨æˆ–è¿”å›é”™è¯¯");
        const data = await resp.json();
        // æœŸæœ› data.locations = ["æ˜†æ˜ä¸œé™†æ ¡åŒº", "ç¿ æ¹–å…¬å›­", "è®²æ­¦å ‚"]
        clearMap();
        const names = (data && data.locations) || [];
        if (!names.length) { msg("åç«¯æœªè¿”å›æœ‰æ•ˆåœ°ç‚¹ï¼Œå°è¯•æ‰‹åŠ¨è®¾ç½®", 'warn'); return; }
        // é€ä¸ªåœ°ç†ç¼–ç å¹¶åšæˆè·¯çº¿
        const coords = [];
        for (let i = 0; i < names.length; i++) {
          const name = names[i];
          const lnglat = await locateByName(name);
          if (lnglat) {
            addMarker(lnglat, i === 0 ? 'start' : i === names.length - 1 ? 'end' : 'via', name);
            coords.push(lnglat);
          }
        }
        fitView();
        if (coords.length >= 2) await plan(coords[0], coords.slice(1, -1), coords[coords.length - 1]);
        msg("è¯­ä¹‰ -> åœ°å›¾ å®Œæˆ");
      } catch (err) { console.error(err); msg("è¯­ä¹‰è§£æå¤±è´¥ï¼šè¯·ç¡®è®¤å·²è¿è¡Œ web.py/app.py", 'error'); }
    }

    // ----------- æ‰‹åŠ¨è·¯å¾„è§„åˆ’ -----------
    async function planManual() {
      const s = $("#start").value.trim();
      const v = $("#via").value.trim();
      const e = $("#end").value.trim();
      if (!s || !e) { msg("èµ·ç‚¹ä¸ç»ˆç‚¹å¿…å¡«", 'warn'); return; }
      clearMap();
      const sLL = await locateByName(s);
      const eLL = await locateByName(e);
      const vias = v ? v.split(/[ï¼Œ,]/).map(x => x.trim()).filter(Boolean) : [];
      const viaLL = [];
      for (let i=0;i<vias.length;i++) { const ll = await locateByName(vias[i]); if (ll) viaLL.push(ll); }
      if (sLL) addMarker(sLL, 'start', s);
      viaLL.forEach((p,i)=> addMarker(p, 'via', vias[i]));
      if (eLL) addMarker(eLL, 'end', e);
      fitView();
      await plan(sLL, viaLL, eLL);
    }

    async function plan(startLL, viaLL, endLL){
      if (!startLL || !endLL) { msg("ç¼ºå°‘èµ·/ç»ˆç‚¹åæ ‡", 'error'); return; }
      msg("æ­£åœ¨è§„åˆ’è·¯çº¿â€¦");
      return new Promise((resolve,reject)=>{
        driving.search({ origin: startLL, destination: endLL, waypoints: viaLL || [] }, (status, result) => {
          if (status === 'complete' && result.routes && result.routes.length) {
            const r = result.routes[0];
            const km = (r.distance/1000).toFixed(1);
            const min = Math.round(r.time/60);
            $("#routePanel").innerHTML = `<div><strong>æ–¹æ¡ˆ</strong>ï¼šçº¦ ${km} km Â· ${min} åˆ†é’Ÿ</div>`;
            msg("è·¯çº¿å°±ç»ª");
            resolve();
          } else { msg("æœªæ‰¾åˆ°åˆé€‚è·¯çº¿", 'warn'); reject(); }
        });
      });
    }

    function fitView(){ map && map.setFitView(null, false, [60,60,60,420]); }

    function locateByName(name){
      return new Promise((resolve)=>{
        geocoder.getLocation(name, (status, result)=>{
          if (status === 'complete' && result.geocodes && result.geocodes.length) {
            const { location } = result.geocodes[0];
            resolve([location.lng, location.lat]);
          } else { msg(`å®šä½å¤±è´¥ï¼š${name}`, 'warn'); resolve(null); }
        });
      });
    }

    function toggleStyle(){
      const styles = ["amap://styles/darkblue","amap://styles/whitesmoke","amap://styles/fresh","amap://styles/macaron"];
      styleIdx = (styleIdx + 1) % styles.length;
      map && map.setMapStyle(styles[styleIdx]);
    }

    function locateKunming(){ map && map.setZoomAndCenter(12, [102.707, 25.044]); }

    // ----------- äº‹ä»¶ç»‘å®š -----------
    async function boot(){
      // ç¤ºä¾‹æ ‡ç­¾
      const ex = $("#examples");
      examples.forEach(t=>{ const span = document.createElement('button'); span.className='chip'; span.textContent=t; span.onclick=()=>($("#query").value=t); ex.appendChild(span); });
      await loadAMap();
      $("#btnPlan").onclick = planManual;
      $("#btnFit").onclick = fitView;
      $("#btnSemantic").onclick = semanticToMap;
      $("#btnClear").onclick = ()=>{ clearMap(); msg("å·²æ¸…ç©º"); };
      $("#btnStyle").onclick = toggleStyle;
      $("#btnLocate").onclick = locateKunming;
    }
    window.addEventListener('DOMContentLoaded', boot);
    <script>
      async function planWithMOA(startText, endText, weights){
        // 1) åœ°ç†ç¼–ç 
        const post = (url, body) => fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json());
        const s = await post('/api/geocode', { q: startText });
        const e = await post('/api/geocode', { q: endText  });
        if (!s.ok || !e.ok) { alert('åœ°ç†ç¼–ç å¤±è´¥'); return; }
      
        // 2) è°ƒç”¨å¤šç›®æ ‡A*ï¼ˆç¤ºä¾‹ï¼šå‡ºç‰‡=å’–å•¡é¦†ï¼Œå®‰é™=å…¬å›­ï¼‰
        const body = {
          start: {lng:s.lnglat[0], lat:s.lnglat[1]},
          end:   {lng:e.lnglat[0], lat:e.lnglat[1]},
          scenic_kw: "å’–å•¡é¦†",
          quiet_kw:  "å…¬å›­",
          weights: weights || { w_dist: 0.7, w_scenic: 0.2, w_quiet: 0.1 },
          grid_n: 26
        };
        const data = await post('/api/plan_moa', body);
        if (!data.ok) { alert('MOA* è§„åˆ’å¤±è´¥ï¼š'+(data.error||'')); return; }
      
        // 3) å°† polyline ç”»åˆ° AMap (å‡è®¾ä½ å·²æœ‰ map å®ä¾‹)
        const path = data.polyline.map(p=> new AMap.LngLat(p[0], p[1]));
        if (window._moaLine) { map.remove(window._moaLine); }
        window._moaLine = new AMap.Polyline({ path, strokeWeight: 6, strokeOpacity: 0.9 });
        map.add(window._moaLine);
        map.setFitView([window._moaLine]);
      }
      </script>
      
  </script>
</body>
</html>
